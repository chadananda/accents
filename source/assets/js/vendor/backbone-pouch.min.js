(function(e){"use strict";function i(){var e={};for(var t=0;t<arguments.length;t++){var n=arguments[t];if(typeof n!=="object"){continue}for(var r in n){if(n[r]&&e[r]&&typeof n[r]==="object"&&typeof e[r]==="object"&&r!=="db"){e[r]=i(e[r]||{},n[r])}else{e[r]=n[r]}}}return e}var t;if(typeof exports==="object"){t=exports}else{t=e.BackbonePouch={}}var n=e._;if(!n&&typeof require==="function"){n=require("underscore")}var r={create:"post",update:"put",patch:"put","delete":"remove"};t.defaults={fetch:"allDocs",listen:false,options:{post:{},put:{},get:{},remove:{},allDocs:{},query:{},spatial:{},changes:{continuous:true}}};t.sync=function(e){e=e||{};e=i(t.defaults,e);var s=function(t,s,o){function u(e,r){if(e){return o.error&&o.error(e)}if(t==="create"||t==="update"||t==="patch"){r={_id:r.id,_rev:r.rev}}if(t==="delete"){r={}}if(t==="read"){if(o.listen){o.db.info(function(e,t){o.db.changes(n.extend({},o.options.changes,{since:t.update_seq,onChange:function(e){var t=s.get(e.id);if(e.deleted){if(t){t.destroy()}}else{if(t){t.set(e.doc)}else{s.add(e.doc)}}if(typeof o.options.changes.onChange==="function"){o.options.changes.onChange(e)}}}))})}}return o.success&&o.success(r)}o=o||{};o=i(e,s&&s.pouch||{},o);if(typeof t!=="string"){return o}if(!o.db){throw new Error('A "db" property must be specified')}s.trigger("request",s,o.db,o);if(t==="read"){if(s.id){return o.db.get(s.id,o.options.get,u)}if(o.fetch==="query"||o.fetch==="spatial"){if(!o.options[o.fetch].fun){throw new Error('A "'+o.fetch+'.fun" object must be specified')}return o.db[o.fetch](o.options[o.fetch].fun,o.options[o.fetch],u)}o.db[o.fetch](o.options[o.fetch],u)}else{o.db[r[t]](s.toJSON(),o.options[r[t]],u)}return o};s.defaults=e;return s};t.attachments=function(e){function t(t){if(t.pouch&&t.pouch.db){return t.pouch.db}if(t.collection&&t.collection.pouch&&t.collection.pouch.db){return t.collection.pouch.db}if(e.db){return e.db}var n=t.sync();if(n.db){return n.db}throw new Error('A "db" property must be specified')}e=e||{};return{attachments:function(e){var t=this.get("_attachments")||{};if(e){return n.filter(n.keys(t),function(n){if(typeof e==="function"){return e(n,t[n])}return t[n].content_type.match(e)})}return n.keys(t)},attachment:function(e,n){var r=t(this);return r.getAttachment(this.id,e,n)},attach:function(e,n,r,i){if(typeof n==="function"){i=n;n=undefined;r=undefined}if(typeof r==="function"){i=r;r=undefined}n=n||e.filename;r=r||e.type;var s=t(this);var o=this;return s.putAttachment(this.id,n,this.get("_rev"),e,r,function(e,t){if(!e&&t.rev){var s=o.get("_attachments")||{};s[n]={content_type:r,stub:true};o.set({_id:t.id,_rev:t.rev,_attachments:s},{silent:true})}i(e,t)})}}}})(this)